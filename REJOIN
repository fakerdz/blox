repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local checkRadius = 150 -- Mở rộng phạm vi để đảm bảo phát hiện người chơi gần
local positionCheckDelay = 180
local checkDelay = 5
local lastPosition = nil
local timeStuck = 0

local function hopToServer()
    local success, errorMessage = pcall(function()
        local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
        print("Đang lấy danh sách server từ:", url)
        local response = HttpService:JSONDecode(game:HttpGet(url))
        local servers = {}
        local minPlayers = nil

        for _, server in ipairs(response.data) do
            if server.id ~= game.JobId and server.playing < server.maxPlayers then
                if minPlayers == nil or server.playing < minPlayers then
                    minPlayers = server.playing
                    servers = {server}
                elseif server.playing == minPlayers then
                    table.insert(servers, server)
                end
            end
        end

        if #servers > 0 then
            local bestServer = servers[math.random(#servers)]
            print("Chuyển sang server:", bestServer.id)
            TeleportService:TeleportToPlaceInstance(game.PlaceId, bestServer.id, LocalPlayer)
        else
            print("Không tìm thấy server phù hợp. Reload lại.")
            TeleportService:Teleport(game.PlaceId)
        end
    end)

    if not success then
        warn("Lỗi khi hop server:", errorMessage)
        TeleportService:Teleport(game.PlaceId)
    end
end

local function isNearPlayer()
    local myPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    if not myPosition then
        print("Không tìm thấy vị trí của nhân vật.")
        return false
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local playerPosition = player.Character.HumanoidRootPart.Position
            local distance = (playerPosition - myPosition).Magnitude
            print("Khoảng cách đến", player.Name, ":", distance)

            if distance <= checkRadius then
                print("Phát hiện người chơi gần:", player.Name)
                return true
            end
        end
    end

    print("Không có người chơi nào gần.")
    return false
end

local function checkStuck()
    local myPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    if myPosition then
        if lastPosition and (myPosition - lastPosition).Magnitude < 2 then
            timeStuck = timeStuck + checkDelay
            print("Phát hiện kẹt. Thời gian bị kẹt:", timeStuck, "giây")
            if timeStuck >= positionCheckDelay then
                print("Kẹt quá lâu, chuyển server...")
                hopToServer()
            end
        else
            timeStuck = 0
        end
        lastPosition = myPosition
    else
        print("Không tìm thấy vị trí của nhân vật.")
    end
end

while true do
    -- Nếu phát hiện người chơi gần, đổi server ngay
    if isNearPlayer() then
        hopToServer()
        break
    end

    -- Kiểm tra kẹt vị trí
    checkStuck()
    task.wait(checkDelay)
end

spawn(function()
    while true do 
        task.wait(300) -- 5 phút
        local Messages = "mua acc tai fakervn . c om"
        game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(Messages, "All")
    end
end)
